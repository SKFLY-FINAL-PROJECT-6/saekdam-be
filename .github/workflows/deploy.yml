name: EC2 ë°°í¬ (SSM ì´ìš©)

on:
    push:
        branches:
            - main

permissions:
    id-token: write
    contents: read

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
              uses: actions/checkout@v3

            - name: AWS ìê²© ì¦ëª… ì„¤ì •
              uses: aws-actions/configure-aws-credentials@v3
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            # 1. EC2 í™˜ê²½ ì¤€ë¹„ (Docker & Java ì„¤ì¹˜)
            - name: EC2 í™˜ê²½ ì¤€ë¹„ (Docker & Java)
              run: |
                  echo "EC2 í™˜ê²½ ì¤€ë¹„ ì‹œì‘..."
                  COMMAND_ID=$(aws ssm send-command \
                    --document-name "AWS-RunShellScript" \
                    --targets "Key=instanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
                    --parameters 'commands=[
                      "sudo yum update -y",
                      "sudo yum install -y docker docker-compose-plugin java-17-amazon-corretto git",
                      "sudo systemctl start docker",
                      "sudo systemctl enable docker",
                      "sudo usermod -aG docker ec2-user",
                      "mkdir -p /home/ec2-user/app",
                      "sudo chown ec2-user:ec2-user /home/ec2-user/app"
                    ]' \
                    --comment "EC2 í™˜ê²½ ì¤€ë¹„ (Docker, Java ì„¤ì¹˜)" \
                    --query "Command.CommandId" \
                    --output text)

                  echo "SSM ëª…ë ¹ì–´ ì‹¤í–‰ ID: $COMMAND_ID"

                  # ìµœëŒ€ 10ë¶„ê¹Œì§€ ì‹¤í–‰ ìƒíƒœ í™•ì¸
                  for i in {1..60}; do
                    STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ secrets.EC2_INSTANCE_ID }}" --query "Status" --output text)
                    echo "í˜„ì¬ ìƒíƒœ: $STATUS"
                    if [[ "$STATUS" == "Success" ]]; then
                      echo "âœ… SSM ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ"
                      break
                    elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
                      echo "âŒ SSM ëª…ë ¹ ì‹¤í–‰ ì‹¤íŒ¨"
                      exit 1
                    fi
                    sleep 10
                  done

            # 2. Docker Compose ì„¤ì¹˜ ë° ê²€ì¦
            - name: Docker Compose ì„¤ì¹˜ ë° ê²€ì¦
              run: |
                  echo "Docker Compose ì„¤ì¹˜ ë° ê²€ì¦ ì‹œì‘..."
                  COMMAND_ID=$(aws ssm send-command \
                    --document-name "AWS-RunShellScript" \
                    --targets "Key=instanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
                    --parameters 'commands=[
                      "if ! docker compose version &>/dev/null; then",
                      "  echo Docker Composeê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ. ì¬ì„¤ì¹˜ ì§„í–‰...",
                      "  sudo yum remove -y docker-compose-plugin",
                      "  sudo yum install -y docker-compose-plugin",
                      "  sudo chmod +x /usr/libexec/docker/cli-plugins/docker-compose",
                      "fi",
                      "docker compose version || echo Docker Compose ì‹¤í–‰ ì‹¤íŒ¨"
                    ]' \
                    --comment "Docker Compose ì„¤ì¹˜ ë° ê²€ì¦" \
                    --query "Command.CommandId" \
                    --output text)

                  echo "SSM ëª…ë ¹ì–´ ì‹¤í–‰ ID: $COMMAND_ID"

                  # ìµœëŒ€ 10ë¶„ê¹Œì§€ ì‹¤í–‰ ìƒíƒœ í™•ì¸
                  for i in {1..60}; do
                    STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ secrets.EC2_INSTANCE_ID }}" --query "Status" --output text)
                    echo "í˜„ì¬ ìƒíƒœ: $STATUS"
                    if [[ "$STATUS" == "Success" ]]; then
                      echo "âœ… SSM ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ"
                      break
                    elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
                      echo "âŒ SSM ëª…ë ¹ ì‹¤í–‰ ì‹¤íŒ¨"
                      exit 1
                    fi
                    sleep 10
                  done

            # 3. ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° ì‹¤í–‰
            - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° ì‹¤í–‰
              run: |
                  echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹œì‘..."
                  COMMAND_ID=$(aws ssm send-command \
                    --document-name "AWS-RunShellScript" \
                    --targets "Key=instanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
                    --parameters 'commands=[
                      "cd /home/ec2-user",
                      "rm -rf app",
                      "echo 'ğŸ”„ Git clone ì‹œì‘...'",
                      "git clone https://github.com/typingmistake/saekdam-be.git app || { echo 'âŒ Git clone ì‹¤íŒ¨'; exit 1; }",
                      "cd /home/ec2-user/app || { echo 'âŒ app ë””ë ‰í† ë¦¬ ì´ë™ ì‹¤íŒ¨'; exit 1; }",
                      "echo 'âœ… Git clone ì™„ë£Œ. ê¶Œí•œ ì„¤ì • ì‹œì‘...'",
                      "sudo chown -R ec2-user:ec2-user /home/ec2-user/app",
                      "chmod -R 755 /home/ec2-user/app",
                      "if [ ! -f gradlew ]; then",
                      "  echo 'âŒ gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤'",
                      "  exit 1",
                      "fi",
                      "chmod +x gradlew",
                      "mkdir -p .gradle",
                      "sudo chown -R ec2-user:ec2-user .gradle",
                      "chmod -R 755 .gradle",
                      "echo 'âœ… Git clone ì™„ë£Œ. Gradle Wrapper ì´ˆê¸°í™” ì‹œì‘...'",
                      "gradle wrapper || { echo 'âŒ Gradle Wrapper ì´ˆê¸°í™” ì‹¤íŒ¨'; exit 1; }",
                      "echo 'âœ… Gradle Wrapper ì´ˆê¸°í™” ì™„ë£Œ'",
                      "ls -la gradle/wrapper/", 'âŒ app ë””ë ‰í† ë¦¬ ì´ë™ ì‹¤íŒ¨'; exit 1; }",
                      "if [ ! -f gradlew ]; then",
                      "  echo 'âŒ gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤'",
                      "  exit 1",
                      "fi",
                      "echo 'âœ… Git clone ì™„ë£Œ. ë””ë ‰í† ë¦¬ ë‚´ìš©:'",
                      "ls -la",
                      "chmod +x gradlew",
                      "./gradlew clean build -x test --stacktrace || { echo 'âŒ Gradle ë¹Œë“œ ì‹¤íŒ¨'; exit 1; }",
                      "if [ ! -f build/libs/*.jar ]; then",
                      "  echo 'âŒ JAR íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'",
                      "  exit 1",
                      "fi",
                      "echo 'âœ… ë¹Œë“œ ì™„ë£Œ. ìƒì„±ëœ JAR íŒŒì¼:'",
                      "ls -la build/libs/",
                      "echo \"DB_HOST=mysql\" > .env",
                      "echo \"DB_PORT=3306\" >> .env",
                      "echo \"DB_NAME=mydatabase\" >> .env",
                      "echo \"DB_USER=myuser\" >> .env",
                      "echo \"DB_PASSWORD=mypassword\" >> .env",
                      "echo \"JWT_SECRET=${{ secrets.JWT_SECRET }}\" >> .env",
                      "echo \"AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY_ID }}\" >> .env",
                      "echo \"AWS_SECRET_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}\" >> .env",
                      "echo \"AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}\" >> .env",
                      "echo \"AWS_REGION=${{ secrets.AWS_REGION }}\" >> .env",
                      "sudo docker compose down || echo No containers to stop",
                      "sudo docker compose --env-file .env up -d",
                      "echo Spring Boot ì‹œì‘ ëŒ€ê¸° 60ì´ˆ...",
                      "sleep 60"
                    ]' \
                    --comment "ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë° ì‹¤í–‰" \
                    --query "Command.CommandId" \
                    --output text)

                  echo "SSM ëª…ë ¹ì–´ ì‹¤í–‰ ID: $COMMAND_ID"

                  # ìµœëŒ€ 10ë¶„ê¹Œì§€ ì‹¤í–‰ ìƒíƒœ í™•ì¸
                  for i in {1..60}; do
                    STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ secrets.EC2_INSTANCE_ID }}" --query "Status" --output text)
                    echo "í˜„ì¬ ìƒíƒœ: $STATUS"
                    if [[ "$STATUS" == "Success" ]]; then
                      echo "âœ… SSM ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ"
                      break
                    elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
                      echo "âŒ SSM ëª…ë ¹ ì‹¤í–‰ ì‹¤íŒ¨"
                      exit 1
                    fi
                    sleep 10
                  done
